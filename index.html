<!DOCTYPE html>
<html>
<head>
    <title>ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³ </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    
    <link rel="icon" type="image/png" href="https://i.imgur.com/xgjafB5.png">
    <link rel="shortcut icon" href="https://i.imgur.com/xgjafB5.png">
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

<style>
    @font-face {
        font-family: 'DungGeunMo';
        src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff') format('woff');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
    }

    :root {
        --dark-wood: #4B2F2A;
        --mid-wood: #6D4C41;
        --dial-color: #F5DEB3;
        --panel-bg: #88624E;
        --screen-bg: rgba(255, 255, 255, 0.95);
        --font-color: #333;
        --gowun-dodum: 'Gowun Dodum', sans-serif;
        --retro-font: 'DungGeunMo', monospace;
        --error-color: var(--dark-wood);
        --scrollDur: 57s;
    }

    body {
        font-family: var(--gowun-dodum);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100dvh;
        background-color: #f4f4f4;
        transition: background-color 0.5s;
    }

    h1, h2, h3, p, div, span, button, li, table, a, select, textarea, input {
        font-family: var(--gowun-dodum) !important;
    }

    .main-content > p { font-size: 1.1em; }
    .main-content h3 { font-size: 1.3em; font-weight: normal; }

    .radio-wrapper {
        position: relative;
        width: min(95vw, 800px);
        aspect-ratio: 4 / 3;
        max-height: min(85vh, 600px);
        height: auto;
        padding-top: 0;
        box-sizing: content-box;
    }

    .radio-container {
        width: 100%;
        height: 100%;
        background-color: var(--mid-wood);
        border-radius: 20px;
        box-shadow: 0 0 0 15px var(--dark-wood),
                    10px 10px 30px rgba(0, 0, 0, 0.5);
        position: relative;
        display: flex;
        flex-direction: column;
        padding: 20px;
        box-sizing: border-box;
        color: var(--font-color);
        transition: all 0.5s;
        z-index: 10;
    }

    .radio-screen {
        flex: 1;
        background-color: var(--screen-bg);
        border-radius: 5px;
        overflow-y: auto;
        position: relative;
        margin-bottom: 20px;
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 15px;
    }

    .main-content {
        flex-grow: 1;
        width: 100%;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .main-content h2 {
        border-bottom: 2px solid var(--panel-bg);
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .main-content .menu-wrapper {
        display: flex;
        justify-content: space-around;
        gap: 20px;
        width: 100%;
        margin-top: 15px;
    }

    .main-content .menu-item-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1 1 30%;
        min-width: 180px;
        text-align: center;
        margin: 0;
    }

    .main-content .menu-item-wrapper > button {
        width: 100%;
        max-width: 250px;
        padding: 15px 15px !important;
        font-size: 1.1em !important;
        font-weight: normal;
        margin-bottom: 5px;
        border-radius: 8px;
        background-color: var(--dial-color);
        color: var(--dark-wood);
        border: 2px solid var(--panel-bg);
        font-family: var(--gowun-dodum) !important;
    }

    .main-content .menu-item-wrapper > p {
        font-size: 0.85em;
        margin: 0;
        line-height: 1.3;
    }

@media (max-width: 768px), (max-aspect-ratio: 3/4) {
    body {
        padding: 16px 14px;
    }

    .radio-wrapper {
        width: 100%;
        height: 92dvh;
        height: 92svh;
        max-height: 92dvh;
        aspect-ratio: auto;
        padding: 0 12px;
        box-sizing: border-box;
    }

    .radio-container {
        height: 100%;
        grid-template-rows: 6fr 4fr;
        padding: 14px;
        box-shadow: 0 0 0 8px var(--dark-wood), 4px 4px 12px rgba(0,0,0,.4);
    }

    .radio-screen {
        min-height: 0;
        max-height: 100%;
        overflow-y: auto;
        position: relative;       margin-bottom: 10px;
        padding: 10px 10px 12px;
    }

    .control-panel {
        flex-direction: column;
        padding: 10px;
    }

        .control-panel > .dial-control {
            display: none;
        }

        .dial-button-group {
            display: flex !important;
            order: 2;
            width: 100%;
            justify-content: space-around;
            margin-bottom: 10px;
        }

        .dial-button-group .dial-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .dial-button-group .radio-dial,
        .radio-dial {
            width: 72px;
            height: 72px;
            font-size: .9em;
            margin: 5px auto;
        }

        .frequency-area {
            order: 1;
            width: 95%;
            padding: 5px 0;
        }

        .center-buttons {
            order: 3;
            width: 100%;
            justify-content: space-around;
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
        }

        .center-buttons button {
            font-size: 0.9em;
            padding: 10px 5px;
            border-radius: 8px !important;
            min-height: 44px;
        }

        .story-player-area {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }

        .story-scroll-container {
            flex: 1 1 auto;
            min-height: 0;
            overflow: hidden;
        }

        .youtube-panel {
            width: 100%;
            min-height: 0;
        }

        .youtube-box {
            height: auto;
            padding: 0;
        }

        .main-content .menu-wrapper {
            flex-direction: column;
            gap: 10px;
        }

        .main-content .menu-item-wrapper {
            width: 100%;
            margin: 5px 0;
        }

        .main-content .menu-item-wrapper > p {
            text-align: left;
        }

        .app-footer {
            display: none;
        }

        @media (max-width: 360px) {
            .qr-size {
                width: 140px !important;
                height: 140px !important;
            }
        }
    }

    #searchResults {
        list-style: none;
        padding: 5px 0 0 0;
        margin: 0;
    }
    #searchResults li {
        padding: 5px 10px;
        border-radius: 5px;
        margin-top: 5px;
        cursor: pointer;
        background-color: rgba(255, 255, 255, 0.7);
        border: 1px dashed var(--panel-bg);
        font-size: 0.9em;
    }
    #searchResults li:hover {
        background-color: var(--dial-color);
    }

    .story-player-area {
        display: flex; 
        flex-grow: 1;
        width: 100%;
        min-height: 300px;
    }

    .scroll-text-box {
        flex: 3; 
        overflow-y: hidden;
        position: relative;
        padding: 10px;
        padding-right: 20px;
        padding-left: 5px;
        border-right: 1px solid #ccc;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .story-text-scrolling {
        position: absolute;
        width: 100%;
        color: var(--dark-wood);
        text-align: center;
        top: 100%;
        left: -10px;
        padding: 0 14px;
        white-space: pre-wrap;
        animation: scrollUp var(--scrollDur) linear forwards;
    }

    .story-text-scrolling.size-small { font-size: 1.2em; }
    .story-text-scrolling.size-large { font-size: 2.4em; }

    @keyframes scrollUp {
        0% { transform: translateY(0); }
        100% { transform: translateY(-2000px); }
    }

    .scroll-text-box h2,
    .scroll-text-box p#playerArea {
        flex-shrink: 0;
        margin-top: 5px;
        margin-bottom: 5px;
    }

    .story-scroll-container {
        flex-grow: 1;
        overflow: hidden;
        position: relative;
        padding: 10px 0;
    }

    .youtube-panel {
        flex: 2; 
        display: flex;
        flex-direction: column;
        padding: 10px;
        height: 100%;
    }

    .youtube-box {
        position: relative;
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        width: 100%;
        aspect-ratio: 16 / 9;
        transition: opacity 0.3s;
    }
    #youtubePlayer,
    #youtubePlayer iframe {
        width: 100%;
        height: 100%;
        max-height: 100%;
        z-index: 1;
        display: block;
    }

    .playback-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

.icon-button.is-on {
    background-color: var(--dial-color);
    color: var(--dark-wood);
}

    .icon-button {
        background-color: var(--dark-wood);
        color: var(--dial-color);
        border: 2px solid var(--panel-bg);
        border-radius: 5px;
        width: 40px;
        height: 40px;
        font-size: 1.5em;
        line-height: 1;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.1s;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .icon-button:hover { background-color: #331f1d; }
    .icon-button[title="ëœë¤ ì¬ìƒ"] { font-family: Arial, sans-serif !important; }

    .font-toggle {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        margin-left: 12px;
    }
    .font-btn {
        min-width: 36px;
        height: 36px;
        border: 2px solid var(--panel-bg);
        border-radius: 5px;
        background: #fff;
        color: var(--dark-wood);
        font-weight: 700;
        line-height: 1;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 8px;
        transition: background-color .15s ease, transform .05s ease;
        font-family: var(--gowun-dodum) !important;
    }
    .font-btn:active { transform: scale(0.98); }
    .font-btn.active { background: var(--dial-color); }

    .form-group { margin-bottom: 15px; }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: var(--dark-wood);
        font-size: 1.1em;
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="password"],
    .form-group textarea,
    .status-select {
        width: 100%;
        padding: 12px;
        font-size: 1.1em;
        font-family: var(--gowun-dodum) !important;
        background-color: var(--dial-color);
        color: var(--dark-wood);
        border: 2px solid var(--panel-bg);
        border-radius: 4px;
        box-sizing: border-box;
    }

    .center-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
        align-self: center;
    }
    .center-buttons button {
        flex-grow: 0;
        width: auto;
        padding: 8px 15px;
        background-color: var(--dial-color);
        color: var(--dark-wood);
        border: 2px solid var(--panel-bg);
        border-radius: 8px;
        font-size: 0.9em;
        font-family: var(--gowun-dodum) !important;
        font-weight: normal;
        cursor: pointer;
    }

    .main-content button[type="submit"],
    .modal-button {
        padding: 10px 20px;
        background-color: var(--dark-wood);
        color: var(--dial-color);
        border: 2px solid var(--panel-bg);
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: normal;
        cursor: pointer;
        transition: background-color 0.1s;
        margin-top: 10px;
        margin-bottom: 20px;
        width: auto;
        display: block;
        margin-left: 0;
        margin-right: auto;
        box-sizing: border-box;
        font-family: var(--gowun-dodum) !important;
    }
    .modal-button {
        width: 100%;
        display: block;
        margin-left: auto;
        margin-right: auto;
        margin-bottom: 0;
    }
    .main-content button[type="submit"]:hover,
    .modal-button:hover { background-color: #331f1d; }

    #writeForm button[type="button"] {
        padding: 8px 15px;
        font-size: 1.1em;
        background-color: var(--panel-bg);
        color: white;
        border-radius: 8px;
        width: auto !important;
        display: inline-block;
        border: none;
        margin-top: 5px;
        font-weight: normal;
        font-family: var(--gowun-dodum) !important;
    }

    .qr-size {
        width: 160px !important;
        height: 160px !important;
        max-width: 160px;
        max-height: 160px;
        background-color: white;
        padding: 10px;
        border: 1px solid #333;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
    }

    .modal-content {
        background-color: var(--screen-bg);
        border: 8px solid var(--dark-wood);
        border-radius: 15px;
        padding: 30px;
        width: min(92vw, 420px);
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        font-family: var(--gowun-dodum);
    }

    .modal-overlay {
        position: fixed !important;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-overlay.show { display: flex !important; }

    .modal-content h3 {
        color: var(--dark-wood);
        font-size: 1.5em;
        border-bottom: 2px dashed var(--panel-bg);
        padding-bottom: 10px;
        margin-top: 0;
    }
    .modal-content strong {
        color: #d90000;
        font-size: 1.2em;
        display: block;
        padding: 5px 0;
        font-family: var(--gowun-dodum);
        font-weight: normal;
    }

    .control-panel {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: var(--panel-bg);
        border: 2px solid var(--dark-wood);
        border-radius: 5px;
        padding: 15px;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }
    .dial-control {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex-shrink: 0;
        width: 100px;
        margin: 0 10px;
    }
    .dial-button-group { display: none; }

    .radio-dial {
        width: 70px;
        height: 70px;
        background-color: var(--dial-color);
        border: 4px solid var(--dark-wood);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        text-align: center;
        cursor: pointer;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3), inset 0 0 3px rgba(0, 0, 0, 0.5);
        transition: all 0.1s;
        padding: 5px;
        box-sizing: border-box;
        line-height: 1.2;
        font-size: 0.85em;
        font-family: var(--gowun-dodum) !important;
    }
    .radio-dial:hover { background-color: #fff8e8; }
    .dummy-dial-label {
        font-size: 0.7em;
        color: var(--dial-color);
        margin-top: 5px;
        text-transform: uppercase;
    }

    .frequency-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0 10px;
    }
    .frequency-display-inner {
        position: relative;
        width: 90%;
        height: 30px;
        background-color: #333;
        border: 1px solid #000;
        border-radius: 3px;
        text-align: center;
        line-height: 30px;
        font-size: 0.9em;
        color: #FFD700;
        font-family: var(--retro-font) !important;
        box-shadow: inset 0 0 5px rgba(255, 215, 0, 0.5);
        overflow: hidden;
    }

    .app-footer {
        margin-top: 20px;
        color: #aaaaaa;
        font-size: 0.8em;
        font-family: var(--gowun-dodum);
    }

    .story-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
        border: 1px solid #ddd;
    }
    .story-table th,
    .story-table td {
        border: 1px solid #ddd;
        padding: 10px 8px;
        text-align: left;
        font-family: var(--gowun-dodum) !important;
    }
    .story-table td[title] { cursor: help; }

    .button-group button {
        background-color: var(--dark-wood) !important;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 15px !important;
        margin-right: 0 !important;
        width: 100%;
        text-align: center;
        transition: background-color 0.1s;
        font-size: 1.1em;
        font-weight: normal;
        font-family: var(--gowun-dodum) !important;
    }
    .button-group button:hover { background-color: #331f1d !important; }

    .story-table td[class^="status-"] {
        font-weight: 700;
        text-align: center;
        border-left: 4px solid transparent;
        transition: background-color .2s ease, box-shadow .2s ease, color .2s ease;
    }
    .story-table td.status-approved { color: #0f5132; text-shadow: 0 0 6px rgba(25,135,84,0.45); }
    .story-table td.status-pending { color: #664d03; text-shadow: 0 0 6px rgba(255,193,7,0.5); }
    .story-table td.status-rejected { color: #842029; text-shadow: 0 0 6px rgba(220,53,69,0.45); }

    .youtube-box { position: relative; }

    .youtube-box::after {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(244,244,244,0.99);
        z-index: 2;
        display: grid;
        place-items: center;
        text-align: center;
        font-size: 0.95em;
        color: #333;
        padding: 10px 16px;
        border-radius: 6px;
        transition: opacity .2s ease;
        opacity: 1;
    }

    .youtube-box:hover::after,
    .youtube-box:focus-within::after {
        opacity: 0;
        pointer-events: none;
    }

    @media (hover: none) and (pointer: coarse) {
        .youtube-box::after {
            opacity: 0;
            pointer-events: none;
        }
    }

    .email-error-inline {
        margin-top: 4px;
        color: #c62828;
        font-size: 0.9em;
        display: none;
    }
    .email-error-inline.show {
        display: block;
    }
@media (max-width: 480px) {
    .frequency-area {
        width: 100%;
    }

    .center-buttons {
        display: flex; 
        flex-wrap: nowrap; 
        gap: 6px;
        justify-content: center;
    }

    .center-buttons button {
        flex: 0 1 auto; 
        min-width: 70px;  
        padding: 6px 4px;  
        font-size: 0.78rem; 
        line-height: 1.1;
        border-radius: 6px !important;
    }

    .frequency-display-inner {
        width: 100%;
        margin-bottom: 6px;
    }
}

@media (max-width: 360px) {
    .center-buttons {
        gap: 4px;
    }
    .center-buttons button {
        min-width: 64px;
        font-size: 0.7rem;
        padding: 5px 3px;
    }
}
</style>

</head>
<body>

    <div class="radio-wrapper">
        <div class="radio-container">

            <div class="radio-screen" id="radioScreen">
                <div class="main-content" id="mainContent">
                    <h2 class="content-title">ğŸ“» ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³  ğŸ’Œ</h2>
                    <p>ì•„ë˜ ë‹¤ì´ì–¼ì„ ëˆŒëŸ¬ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•˜ì„¸ìš”!</p>
                    <p>ğŸ“ ì‚¬ì—° ì“°ê¸° : ì‚¬ì—°ì„ ì ê³  ì‹ ì²­ê³¡ê³¼ í•¨ê»˜ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.</p>
                    <p>ğŸ”‘ ì‚¬ì—° ê´€ë¦¬ : ì±„ë„ì„ ê°œì„¤í•˜ê³  ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.</p>
                </div>
            </div>

            <div class="control-panel">

                <div class="dial-control">
                    <div class="radio-dial" onclick="loadContent('write')">ì‚¬ì—°<br>ì“°ê¸°</div>
                    <div class="dummy-dial-label">VOLUME</div>
                </div>

                <div class="dial-button-group">
                    <div class="dial-control">
                        <div class="radio-dial" onclick="loadContent('write')">ì‚¬ì—°<br>ì“°ê¸°</div>
                        <div class="dummy-dial-label">VOLUME</div>
                    </div>
                    <div class="dial-control">
                        <div class="radio-dial" onclick="loadContent('manage_menu')">ì‚¬ì—°<br>ê´€ë¦¬</div>
                        <div class="dummy-dial-label">TUNING</div>
                    </div>
                </div>

                <div class="frequency-area">
                    <div class="frequency-display-inner" id="frequencyDisplay">
                        ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³  - í™˜ì˜í•©ë‹ˆë‹¤!
                    </div>
                    <div class="center-buttons">
                        <button onclick="showQrCode()">QR CODE</button>
                        <button onclick="loadContent('welcome')">HOME</button>
                        <button onclick="goBack()">BACK</button>
                    </div>
                </div>

                <div class="dial-control">
                    <div class="radio-dial" onclick="loadContent('manage_menu')">ì‚¬ì—°<br>ê´€ë¦¬</div>
                    <div class="dummy-dial-label">TUNING</div>
                </div>
            </div>
        </div>
    </div>

    <div class="app-footer">
        Copyright Â© 2025 íœ´ë¥´ìŒ¤. All rights reserved.
    </div>

    <div id="resultModalOverlay" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modalTitle">ì±„ë„ ìƒì„± ì™„ë£Œ</h3>
            <p id="modalMessage"></p>
            <p>í•€ ë²ˆí˜¸: <strong id="modalPin"></strong></p>
            <p>ê´€ë¦¬ ë¹„ë°€ë²ˆí˜¸: <strong id="modalPassword"></strong></p>
            <button class="modal-button" onclick="closeModal()">í™•ì¸</button>
        </div>
    </div>
<script>
const WORKER_API_ENDPOINT = 'https://radio.bbglara.workers.dev/';

const mainContent = document.getElementById('mainContent');
const frequencyDisplay = document.getElementById('frequencyDisplay');
const radioScreen = document.getElementById('radioScreen');

let currentChannelPin = null;
let currentChannelName = null;
let managerPassword = null;
let isStorySubmitted = false;

const pageHistory = [];
const MAX_HISTORY_SIZE = 5;


let textSizeMode = 'small';Â 
let isRepeatScrolling = false;Â 

let scrollWatchTimer = null;
const SCROLL_SPEED = 5;Â  Â  Â  Â Â 
const MIN_SCROLL_SEC = 8;
const MAX_SCROLL_SEC = 70;

let storyData = [];Â 
let originalApprovedStories = []; // ğŸ’¡ ì „ì²´ ìŠ¹ì¸ëœ ì‚¬ì—°ì„ ì €ì¥í•  ë°°ì—´ ì¶”ê°€
let approvedUnplayedCount = 0;Â 
let currentPlayOrder = 0;Â 
let currentStoryIndex = -1; // ğŸ’¡ -1ë¡œ ì´ˆê¸°í™” (ì¬ìƒ ëª©ë¡ì˜ ì¸ë±ìŠ¤)
let playMode = 'random';Â 
let player = null;Â 

let lastStartedRowNum = null;
let lastStartedStamp = 0;

let loadingInterval = null;

function looksLikeCommonEmailTypo(domain) {
Â  Â  const obviousTypos = [
Â  Â  Â  Â  'gmal.com', 'gmai.com', 'gmaii.com', 'gmail.co', 'gmail.con',
Â  Â  Â  Â  'naver.net', 'nvaer.com', 'naver.co',
Â  Â  Â  Â  'daum.com',
Â  Â  Â  Â  'kako.com', 'kakao.co'
Â  Â  ];
Â  Â  return obviousTypos.includes(domain);
}

function isEmailAllowed(value) {
Â  Â  if (!value) return false;
Â  Â  const t = value.trim();
Â  Â  const basicPattern = /^[^@]+@[^@]+\.[^@]+$/;
Â  Â  if (!basicPattern.test(t)) return false;

Â  Â  const domain = t.split('@')[1].toLowerCase();
Â  Â  if (looksLikeCommonEmailTypo(domain)) return false;

Â  Â  const common = [
Â  Â  Â  Â  'gmail.com', 'naver.com', 'daum.net', 'kakao.com',
Â  Â  Â  Â  'outlook.com', 'hotmail.com'
Â  Â  ];
Â  Â  if (common.includes(domain)) return true;

Â  Â  const allowEnds = [
Â  Â  Â  Â  '.kr', '.go.kr', '.or.kr', '.sch.kr', '.es.kr', '.ms.kr', '.hs.kr', '.korea.kr'
Â  Â  ];
Â  Â  if (allowEnds.some(sfx => domain.endsWith(sfx))) return true;

Â  Â  return true;
}

async function callWorker(action, data = {}) {
Â  Â  try {
Â  Â  Â  Â  const response = await fetch(WORKER_API_ENDPOINT, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action, ...data })
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  const errorBody = await response.json().catch(() => ({ message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì‘ë‹µ í˜•ì‹' }));
Â  Â  Â  Â  Â  Â  throw new Error(`HTTP ${response.status}: ${errorBody.message || response.statusText}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  return await response.json();
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Worker í†µì‹  ì‹¤íŒ¨:', error);
Â  Â  Â  Â  return { success: false, message: `ì„œë²„ í†µì‹  ì˜¤ë¥˜: ${error.message}` };
Â  Â  }
}

function startLoadingAnimation(baseMessage) {
Â  Â  stopLoadingAnimation();
Â  Â  let dots = 1;
Â  Â  const loadingTitle = 'loading';
Â  Â  loadingInterval = setInterval(() => {
Â  Â  Â  Â  let dotString = '.'.repeat(dots);
Â  Â  Â  Â  frequencyDisplay.textContent = `[${loadingTitle}] ${baseMessage}${dotString}`;
Â  Â  Â  Â  dots++;
Â  Â  Â  Â  if (dots > 3) dots = 1;
Â  Â  }, 500);
}
function stopLoadingAnimation() {
Â  Â  if (loadingInterval) {
Â  Â  Â  Â  clearInterval(loadingInterval);
Â  Â  Â  Â  loadingInterval = null;
Â  Â  }
}

function showModal(title, pin, password, emailFailed = false) {
Â  Â  const msgEl = document.getElementById('modalMessage');
Â  Â  if (emailFailed) {
Â  Â  Â  Â  msgEl.innerHTML = 'ì‚¬ì—° ë³´ë‚´ê¸° ë° ê´€ë¦¬ì ë¡œê·¸ì¸ì„ ìœ„í•´<br>ë‹¤ìŒ ì •ë³´ë¥¼ ê¼­ ì €ì¥í•´ ì£¼ì„¸ìš”!<br><br><strong style="color:#c62828;">â€» ì´ë©”ì¼ì´ ë°œì†¡ë˜ì§€ ì•Šì•˜ì–´ìš”. ì•„ë˜ PIN/ë¹„ë²ˆì„ ê¼­ ìº¡ì²˜í•´ ë‘ì„¸ìš”.</strong>';
Â  Â  } else {
Â  Â  Â  Â  msgEl.innerHTML = 'ì‚¬ì—° ë³´ë‚´ê¸° ë° ê´€ë¦¬ì ë¡œê·¸ì¸ì„ ìœ„í•´<br>ë‹¤ìŒ ì •ë³´ë¥¼ ê¼­ ì €ì¥í•´ ì£¼ì„¸ìš”!';
Â  Â  }

Â  Â  document.getElementById('modalTitle').textContent = title;
Â  Â  document.getElementById('modalPin').textContent = pin;
Â  Â  document.getElementById('modalPassword').textContent =
Â  Â  Â  Â  (password && String(password).trim() !== '')
Â  Â  Â  Â  Â  Â  ? password
Â  Â  Â  Â  Â  Â  : '(ì²˜ìŒ ì…ë ¥í•œ 4ìë¦¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”)';
Â  Â  document.getElementById('resultModalOverlay').classList.add('show');
}
function closeModal() {
Â  Â  document.getElementById('resultModalOverlay').classList.remove('show');
Â  Â  loadContent('manage_menu');
}

function initFontToggleListeners() {
Â  Â  const sm = document.getElementById('fontSmallBtn');
Â  Â  const lg = document.getElementById('fontLargeBtn');
Â  Â  if (!sm || !lg) return;
Â  Â  sm.classList.toggle('active', textSizeMode === 'small');
Â  Â  lg.classList.toggle('active', textSizeMode === 'large');

Â  Â  sm.onclick = () => setTextSize('small');
Â  Â  lg.onclick = () => setTextSize('large');
}
function setTextSize(mode) {
Â  Â  textSizeMode = (mode === 'large') ? 'large' : 'small';
Â  Â  const sm = document.getElementById('fontSmallBtn');
Â  Â  const lg = document.getElementById('fontLargeBtn');
Â  Â  if (sm && lg) {
Â  Â  Â  Â  sm.classList.toggle('active', textSizeMode === 'small');
Â  Â  Â  Â  lg.classList.toggle('active', textSizeMode === 'large');
Â  Â  }
Â  Â  applyTextSize(true);
}
function applyTextSize(preserveProgress) {
Â  Â  const el = document.getElementById('scrollingText');
Â  Â  if (!el) return;

Â  Â  let savedTime = null;
Â  Â  let anim = null;
Â  Â  if (el.getAnimations) { // ğŸ’¡ Animation API ì‚¬ìš© ì—¬ë¶€ ì²´í¬
Â  Â  Â  Â  const animations = el.getAnimations();
Â  Â  Â  Â  anim = animations.length > 0 ? animations[0] : null;

Â  Â  Â  Â  if (preserveProgress && anim && anim.currentTime != null && anim.playState === 'running') {
Â  Â  Â  Â  Â  Â  savedTime = anim.currentTime;
Â  Â  Â  Â  Â  Â  anim.pause(); // ì¼ì‹œ ì¤‘ì§€í•˜ì—¬ ìœ„ì¹˜ ì €ì¥
Â  Â  Â  Â  }
Â  Â  }


Â  Â  el.classList.remove('size-small', 'size-large');
Â  Â  el.classList.add(textSizeMode === 'large' ? 'size-large' : 'size-small');

Â  Â  // ğŸ’¡ CSS ë³€ìˆ˜ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì¬ì‹œì‘
Â  Â  el.style.animation = 'none';
Â  Â  
Â  Â  setTimeout(() => {
Â  Â  Â  Â  if (savedTime !== null && anim) {
Â  Â  Â  Â  Â  Â  setScrollAnimationDuration(el); // ìƒˆë¡œìš´ ê¸€ì í¬ê¸°ì— ë§ì¶° ì§€ì† ì‹œê°„ ì¬ê³„ì‚°
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const newAnim = el.getAnimations()[0];
Â  Â  Â  Â  Â  Â  if (newAnim) {
Â  Â  Â  Â  Â  Â  Â  Â  newAnim.currentTime = savedTime; // ì €ì¥ëœ ì‹œê°„ìœ¼ë¡œ ë³µì› ì‹œë„
Â  Â  Â  Â  Â  Â  Â  Â  newAnim.play();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  restartCurrentScrolling(); // ì• ë‹ˆë©”ì´ì…˜ì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì¬ì‹œì‘
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  restartCurrentScrolling(); // ì´ˆê¸° ë¡œë”© ë˜ëŠ” ì¬ìƒ ì¤‘ì´ ì•„ë‹ˆë©´ ê·¸ëƒ¥ ì¬ì‹œì‘
Â  Â  Â  Â  }
Â  Â  }, 10);
}

function getChannelTitle(page) {
Â  Â  switch (page) {
Â  Â  Â  Â  case 'listen': return 'ON AIR';
Â  Â  Â  Â  case 'write': return 'ì‚¬ì—° ë³´ë‚´ê¸°';
Â  Â  Â  Â  case 'manage_menu':
Â  Â  Â  Â  case 'create_channel':
Â  Â  Â  Â  case 'login_manage_stories':
Â  Â  Â  Â  case 'login_listen':
Â  Â  Â  Â  case 'list_stories':
Â  Â  Â  Â  Â  Â  return 'ê´€ë¦¬ì';
Â  Â  Â  Â  case 'qrcode': return 'QR ì½”ë“œ';
Â  Â  Â  Â  default: return 'ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³ ';
Â  Â  }
}

function loadContent(page, skipHistory = false) {
Â  Â  let html = '';

Â  Â  stopLoadingAnimation();

Â  Â  if (!skipHistory) {
Â  Â  Â  Â  if (pageHistory.length === 0 || pageHistory[pageHistory.length - 1] !== page) {
Â  Â  Â  Â  Â  Â  pageHistory.push(page);
Â  Â  Â  Â  Â  Â  if (pageHistory.length > MAX_HISTORY_SIZE) pageHistory.shift();
Â  Â  Â  Â  }
Â  Â  Â  Â  history.replaceState({ page: page }, null, `#${page}`);
Â  Â  }

Â  Â  if (page === 'welcome') {
Â  Â  Â  Â  frequencyDisplay.textContent = 'ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³  - í™˜ì˜í•©ë‹ˆë‹¤!';
Â  Â  } else {
Â  Â  Â  Â  frequencyDisplay.textContent = `[${getChannelTitle(page)}] ì±„ë„`;
Â  Â  }

Â  Â  switch (page) {
Â  Â  Â  Â  case 'welcome':
Â  Â  Â  Â  Â  Â  html = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="content-title">ğŸ“» ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³  ğŸ’Œ</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p>ì•„ë˜ ë‹¤ì´ì–¼ì„ ëˆŒëŸ¬ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•˜ì„¸ìš”!</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸ“ ì‚¬ì—° ì“°ê¸° : ì‚¬ì—°ì„ ì ê³  ì‹ ì²­ê³¡ê³¼ í•¨ê»˜ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸ”‘ ì‚¬ì—° ê´€ë¦¬ : ì±„ë„ì„ ê°œì„¤í•˜ê³  ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.</p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'listen':
Â  Â  Â  Â  Â  Â  if (!currentChannelPin || !currentChannelName) {
Â  Â  Â  Â  Â  Â  Â  Â  html = `<p style="color: red;">ğŸ¶ ì‚¬ì—° ë³´ê¸°ëŠ” ê´€ë¦¬ì ì±„ë„ ë¡œê·¸ì¸ í›„ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ”‘</p>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  html = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="story-player-area">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="scroll-text-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="content-title">ğŸ¶ ì‚¬ì—° ë³´ê¸°</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="playerArea" style="margin-top: 10px;">ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="story-scroll-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="scrollingText" class="story-text-scrolling size-${textSizeMode}" style="animation:none; top:100%;"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="youtube-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="playback-controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="repeatScrollBtn" class="icon-button ${isRepeatScrolling ? 'is-on' : ''}" title="ì‚¬ì—° ë°˜ë³µ ì¬ìƒ" onclick="toggleRepeatScrolling(this)">&#8634;</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="icon-button" title="ìˆœì°¨ ì¬ìƒ" onclick="playStories('sequential')">&#9654;</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="icon-button" title="ëœë¤ ì¬ìƒ" onclick="playStories('random')">&#8644;</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-toggle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="fontSmallBtn" class="font-btn ${textSizeMode === 'small' ? 'active' : ''}">a</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="fontLargeBtn" class="font-btn ${textSizeMode === 'large' ? 'active' : ''}">A</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="currentStoryInfo"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="youtube-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="youtubePlayer"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'write':
Â  Â  Â  Â  case 'pin_entry':
Â  Â  Â  Â  Â  Â  html = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="content-title">ğŸ“ ì‚¬ì—° ì“°ê¸°</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="pinForm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="pin">ì£¼íŒŒìˆ˜ë¥¼ ë§ì¶°ì£¼ì„¸ìš”! (6ìë¦¬ í•€ë²ˆí˜¸)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="pin" maxlength="6" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit">ì±„ë„ ì…ì¥</button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="writeForm" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="content-title" id="channelNameDisplay"></h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="storyForm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="storyName">ì´ë¦„:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="storyName" placeholder="í™ê¸¸ë™" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="storyContent">ì‚¬ì—° ë‚´ìš©:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="storyContent" rows="4" placeholder="ë³´ë‚´ê³  ì‹¶ì€ ë§ˆìŒì„ ë‹´ì•„ ì£¼ì„¸ìš”."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="border-bottom: 1px solid #ddd; padding-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="searchQuery">ì›í•˜ëŠ” ê³¡ ê²€ìƒ‰ (ê°€ìˆ˜, ì œëª© ìˆœì„œë¡œ ì“°ê¸°):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="searchQuery" placeholder="ì˜ˆ: ìœ¤í•˜, ì‚¬ê±´ì˜ ì§€í‰ì„ " style="margin-bottom: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="handleSearch()" >ê³¡ ê²€ìƒ‰</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul id="searchResults"></ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="storyUrl">ì„ íƒëœ ìœ íŠœë¸Œ URL (ë˜ëŠ” ì§ì ‘ ì…ë ¥):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="storyUrl" placeholder="ì„ íƒ í›„ ìë™ ì…ë ¥ë©ë‹ˆë‹¤." required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit">ì‚¬ì—° ë³´ë‚´ê¸°</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="submissionStatus" style="margin-top: 15px; color: var(--error-color); font-weight: bold;"></p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'manage_menu':
Â  Â  Â  Â  Â  Â  html = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="content-title">ğŸ”‘ ê´€ë¦¬ì ë©”ë‰´</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-item-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="loadContent('create_channel')">ì±„ë„ ë§Œë“¤ê¸°</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>ëª¨ë“  ì‚¬ì—°ì´ ì¬ìƒëœ ì±„ë„ì€ <br> ìì •ì— ìë™ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-item-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="loadContent('login_manage_stories')">ì‚¬ì—° ê´€ë¦¬ (ìŠ¹ì¸/ê±°ì ˆ)</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>ë¡œê·¸ì¸ í›„ ë„ì°©í•œ ì‚¬ì—°ì„ <br> ìŠ¹ì¸/ê±°ì ˆí•©ë‹ˆë‹¤. (ìŠ¹ì¸ ìƒíƒœë§Œ ì¬ìƒ)</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-item-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="loadContent('login_listen')">ì‚¬ì—° ë³´ê¸° (ì±„ë„ ì—°ê²°)</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>ë¡œê·¸ì¸ í›„ ìŠ¹ì¸ëœ ì‚¬ì—°ì„ <br> ìˆœì°¨/ëœë¤ ì¬ìƒí•©ë‹ˆë‹¤.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'create_channel':
Â  Â  Â  Â  Â  Â  html = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="content-title">ğŸ› ï¸ ìƒˆ ì±„ë„ ë§Œë“¤ê¸°</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="createChannelForm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="channelName">ì±„ë„ëª…:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="channelName" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="teacherEmail">ì´ë©”ì¼:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="teacherEmail" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="emailErrorInline" class="email-error-inline">ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤. ì£¼ì†Œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="teacherPassword">ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="teacherPassword" maxlength="4" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="passwordErrorInline" class="email-error-inline">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ì–´ ì†Œë¬¸ìì™€ ìˆ«ìë¡œ ëœ 4ê¸€ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit">ì±„ë„ ìƒì„±</button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="createStatus" style="margin-top: 15px; color: var(--error-color); font-weight: bold;"></p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'login_manage_stories':
Â  Â  Â  Â  case 'login_listen':
Â  Â  Â  Â  Â  Â  html = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="content-title">ğŸ”’ ì‚¬ì—° ${page === 'login_listen' ? 'ë³´ê¸°' : 'ê´€ë¦¬'} ë¡œê·¸ì¸</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="manageLoginForm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="managerPin">ì±„ë„ PIN ë²ˆí˜¸ (6ìë¦¬):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="managerPin" maxlength="6" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="managerPassword">ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="managerPassword" maxlength="4" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit">ë¡œê·¸ì¸ ë° ${page === 'login_listen' ? 'ë“£ê¸°' : 'ëª©ë¡ ë³´ê¸°'}</button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="manageLoginStatus" style="margin-top: 15px; color: var(--error-color); font-weight: bold;"></p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'list_stories':
Â  Â  Â  Â  Â  Â  html = `<h2 class="content-title">ğŸ“ [${currentChannelName}] ì‚¬ì—° ëª©ë¡</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="storyListArea"><p>ì‚¬ì—° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>`;
Â  Â  Â  Â  Â  Â  setTimeout(fetchStoriesForManagement, 50);
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'qrcode':
Â  Â  Â  Â  Â  Â  html = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="content-title">ì ‘ì†ìš© QR ì½”ë“œ</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="qrCodeContainer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="qrcode" class="qr-size"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  setTimeout(generateQrCode, 100);
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  html = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="content-title">ğŸ“» ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³  ğŸ’Œ</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p>ì•„ë˜ ë‹¤ì´ì–¼ì„ ëˆŒëŸ¬ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•˜ì„¸ìš”!</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸ“ ì‚¬ì—° ì“°ê¸° : ì‚¬ì—°ì„ ì ê³  ì‹ ì²­ê³¡ê³¼ í•¨ê»˜ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸ”‘ ì‚¬ì—° ê´€ë¦¬ : ì±„ë„ì„ ê°œì„¤í•˜ê³  ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.</p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  frequencyDisplay.textContent = 'ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³  - í™˜ì˜í•©ë‹ˆë‹¤!';
Â  Â  }

Â  Â  mainContent.innerHTML = html;

Â  Â  if (page === 'listen') {
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  initFontToggleListeners();
Â  Â  Â  Â  Â  Â  applyTextSize(false);
Â  Â  Â  Â  Â  Â  const repeatBtn = document.getElementById('repeatScrollBtn');
Â  Â  Â  Â  Â  Â  if (repeatBtn) repeatBtn.classList.toggle('is-on', isRepeatScrolling);
Â  Â  Â  Â  }, 0);
Â  Â  }

Â  Â  if (page === 'write' || page === 'pin_entry') {
Â  Â  Â  Â  setupStoryFormListeners();
Â  Â  } else if (page === 'create_channel') {
Â  Â  Â  Â  document.getElementById('createChannelForm').addEventListener('submit', handleCreateChannel);
Â  Â  } else if (page === 'login_manage_stories' || page === 'login_listen') {
Â  Â  Â  Â  document.getElementById('manageLoginForm').addEventListener('submit', (e) => handleManageLogin(e, page));
Â  Â  }
}

function goBack() {
Â  Â  if (pageHistory.length > 1) {
Â  Â  Â  Â  pageHistory.pop();
Â  Â  Â  Â  const previousPage = pageHistory[pageHistory.length - 1];
Â  Â  Â  Â  loadContent(previousPage, true);
Â  Â  } else {
Â  Â  Â  Â  loadContent('welcome', true);
Â  Â  }
}

function showQrCode() {
Â  Â  loadContent('qrcode');
Â  Â  frequencyDisplay.textContent = '[QR CODE] - ì ‘ì† ì£¼íŒŒìˆ˜';
}
function generateQrCode() {
Â  Â  const url = window.location.href.split('#')[0];
Â  Â  const qrcodeElement = document.getElementById('qrcode');
Â  Â  qrcodeElement.innerHTML = '';
Â  Â  new QRCode(qrcodeElement, {
Â  Â  Â  Â  text: url,
Â  Â  Â  Â  width: 160,
Â  Â  Â  Â  height: 160,
Â  Â  Â  Â  colorDark : "#000000",
Â  Â  Â  Â  colorLight : "#ffffff",
Â  Â  Â  Â  correctLevel : QRCode.CorrectLevel.H
Â  Â  });
}

async function handleCreateChannel(e) {
Â  Â  e.preventDefault();

Â  Â  const btn = e.target.querySelector('button[type="submit"]');
Â  Â  const createStatus = document.getElementById('createStatus');
Â  Â  const emailInput = document.getElementById('teacherEmail');
Â  Â  const emailErrorInline = document.getElementById('emailErrorInline');
Â  Â  const passwordErrorInline = document.getElementById('passwordErrorInline');

Â  Â  if (btn) {
Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  btn.textContent = 'ìƒì„± ì¤‘...';
Â  Â  }

Â  Â  const channelName = document.getElementById('channelName').value.trim();
Â  Â  const teacherEmail = emailInput.value.trim();
Â  Â  const teacherPassword = document.getElementById('teacherPassword').value.trim();

Â  Â  if (!isEmailAllowed(teacherEmail)) {
Â  Â  Â  Â  emailErrorInline.textContent = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤. ì£¼ì†Œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.';
Â  Â  Â  Â  emailErrorInline.classList.add('show');
Â  Â  Â  Â  createStatus.textContent = '';
Â  Â  Â  Â  if (btn) {
Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  btn.textContent = 'ì±„ë„ ìƒì„±';
Â  Â  Â  Â  }
Â  Â  Â  Â  return;
Â  Â  } else {
Â  Â  Â  Â  emailErrorInline.classList.remove('show');
Â  Â  }

Â  Â  if (!/^[a-z0-9]{4}$/.test(teacherPassword)) {
Â  Â  Â  Â  passwordErrorInline.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ì–´ ì†Œë¬¸ìì™€ ìˆ«ìë¡œ ëœ 4ê¸€ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”. ì˜ˆ: ab12, lov3, dj01';
Â  Â  Â  Â  passwordErrorInline.classList.add('show');
Â  Â  Â  Â  createStatus.textContent = '';
Â  Â  Â  Â  if (btn) {
Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  btn.textContent = 'ì±„ë„ ìƒì„±';
Â  Â  Â  Â  }
Â  Â  Â  Â  return;
Â  Â  } else {
Â  Â  Â  Â  passwordErrorInline.classList.remove('show');
Â  Â  }

Â  Â  const pin = Math.floor(100000 + Math.random() * 900000).toString();

Â  Â  startLoadingAnimation('ì±„ë„ ìƒì„± ì¤‘');
Â  Â  createStatus.textContent = 'âœ¨ ì±„ë„ ìƒì„± ì¤‘...';

Â  Â  const res = await callWorker('createChannel', {
Â  Â  Â  Â  channelName,
Â  Â  Â  Â  teacherEmail,
Â  Â  Â  Â  teacherPassword,
Â  Â  Â  Â  pin
Â  Â  });

Â  Â  stopLoadingAnimation();

Â  Â  if (res.success) {
Â  Â  Â  Â  const finalPassword = (res.password && String(res.password).trim() !== '')
Â  Â  Â  Â  Â  Â  ? res.password
Â  Â  Â  Â  Â  Â  : teacherPassword;

Â  Â  Â  Â  showModal(
Â  Â  Â  Â  Â  Â  `${channelName} ì±„ë„ ìƒì„± ì™„ë£ŒğŸ‰`,
Â  Â  Â  Â  Â  Â  res.pin,
Â  Â  Â  Â  Â  Â  finalPassword,
Â  Â  Â  Â  Â  Â  res.emailFailed
Â  Â  Â  Â  );

Â  Â  Â  Â  if (res.emailFailed) {
Â  Â  Â  Â  Â  Â  createStatus.textContent = 'ì±„ë„ì€ ìƒì„±ëì§€ë§Œ ì´ë©”ì¼ ë°œì†¡ì€ ì‹¤íŒ¨í–ˆì–´ìš”. PINì„ ê¼­ ì €ì¥í•´ ë‘ì„¸ìš”!';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  createStatus.textContent = '';
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  createStatus.textContent = res.message;
Â  Â  Â  Â  createStatus.style.color = 'red';
Â  Â  }

Â  Â  if (btn) {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.textContent = 'ì±„ë„ ìƒì„±';
Â  Â  }
}

function setupStoryFormListeners() {
Â  Â  const pinForm = document.getElementById('pinForm');
Â  Â  const storyFormContainer = document.getElementById('writeForm');
Â  Â  const storyForm = document.getElementById('storyForm');

Â  Â  pinForm.addEventListener('submit', async (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const pin = document.getElementById('pin').value;
Â  Â  Â  Â  const channelNameDisplay = document.getElementById('channelNameDisplay');
Â  Â  Â  Â  const submissionStatus = document.getElementById('submissionStatus');

Â  Â  Â  Â  startLoadingAnimation('PIN ê²€ì¦ ì¤‘');
Â  Â  Â  Â  submissionStatus.textContent = '';

Â  Â  Â  Â  const res = await callWorker('getChannelInfoByPin', { pin });

Â  Â  Â  Â  stopLoadingAnimation();

Â  Â  Â  Â  if (res.success) {
Â  Â  Â  Â  Â  Â  currentChannelPin = pin;
Â  Â  Â  Â  Â  Â  currentChannelName = res.channelName;

Â  Â  Â  Â  Â  Â  pinForm.style.display = 'none';
Â  Â  Â  Â  Â  Â  storyFormContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  frequencyDisplay.textContent = `[${currentChannelName}] ì£¼íŒŒìˆ˜ ì¼ì¹˜!`;

Â  Â  Â  Â  Â  Â  channelNameDisplay.textContent = `[${currentChannelName}]ì— ì‚¬ì—° ë³´ë‚´ê¸°`;

Â  Â  Â  Â  Â  Â  if (isStorySubmitted) {
Â  Â  Â  Â  Â  Â  Â  Â  storyForm.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  submissionStatus.textContent = 'ì‚¬ì—°ì€ í•œ ë²ˆë§Œ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  storyForm.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  submissionStatus.textContent = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  submissionStatus.textContent = `ì˜¤ë¥˜: ${res.message}`;
Â  Â  Â  Â  Â  Â  currentChannelPin = null;
Â  Â  Â  Â  Â  Â  currentChannelName = null;
Â  Â  Â  Â  }
Â  Â  });

Â  Â  storyForm.addEventListener('submit', handleStorySubmit);
}

async function handleStorySubmit(e) {
Â  Â  e.preventDefault();

Â  Â  if (isStorySubmitted || !currentChannelPin) {
Â  Â  Â  Â  alert('ì±„ë„ ì¸ì¦ì´ í•„ìš”í•˜ê±°ë‚˜ ì´ë¯¸ ì‚¬ì—°ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ğŸ’¡');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const form = document.getElementById('storyForm');
Â  Â  const submitBtn = form.querySelector('button[type="submit"]');
Â  Â  if (submitBtn) {
Â  Â  Â  Â  submitBtn.disabled = true;
Â  Â  Â  Â  submitBtn.textContent = 'ë³´ë‚´ëŠ” ì¤‘...';
Â  Â  }

Â  Â  const name = document.getElementById('storyName').value;
Â  Â  const content = document.getElementById('storyContent').value;
Â  Â  const url = document.getElementById('storyUrl').value;
Â  Â  const statusDiv = document.getElementById('submissionStatus');

Â  Â  startLoadingAnimation('ì‚¬ì—° ë³´ë‚´ëŠ” ì¤‘');
Â  Â  statusDiv.textContent = 'ë³´ë‚´ëŠ” ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';

Â  Â  const res = await callWorker('submitStory', {
Â  Â  Â  Â  name: name,
Â  Â  Â  Â  content: content,
Â  Â  Â  Â  youtubeUrl: url,
Â  Â  Â  Â  pin: currentChannelPin
Â  Â  });

Â  Â  stopLoadingAnimation();

Â  Â  if (res.success) {
Â  Â  Â  Â  statusDiv.textContent = 'âœ… ì‚¬ì—°ì„ ë³´ëƒˆìŠµë‹ˆë‹¤! (ìŠ¹ì¸ ëŒ€ê¸° ì¤‘)';
Â  Â  Â  Â  isStorySubmitted = true;
Â  Â  Â  Â  form.style.display = 'none';
Â  Â  } else {
Â  Â  Â  Â  statusDiv.textContent = `ì˜¤ë¥˜ ë°œìƒ: ${res.message}`;
Â  Â  Â  Â  if (submitBtn) {
Â  Â  Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  Â  Â  Â  Â  submitBtn.textContent = 'ì‚¬ì—° ë³´ë‚´ê¸°';
Â  Â  Â  Â  }
Â  Â  }
}

async function handleManageLogin(e, loginType) {
Â  Â  e.preventDefault();
Â  Â  const pin = document.getElementById('managerPin').value;
Â  Â  const password = document.getElementById('managerPassword').value;
Â  Â  const loginStatus = document.getElementById('manageLoginStatus');

Â  Â  startLoadingAnimation('ë¡œê·¸ì¸ ì¤‘');
Â  Â  loginStatus.textContent = 'ë¡œê·¸ì¸ ì¤‘...';

Â  Â  // ğŸ’¡ ì¸ì¦ ë° ì±„ë„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
Â  Â  const channelInfo = await callWorker('getChannelInfoByPin', { pin });
Â  Â  if (!channelInfo.success) {
Â  Â  Â  Â  stopLoadingAnimation();
Â  Â  Â  Â  loginStatus.textContent = `ì¸ì¦ ì‹¤íŒ¨: ${channelInfo.message}`;
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // ğŸ’¡ getAllStoriesëŠ” ë°ì´í„° ë¡œë”© ëª©ì ì´ë¯€ë¡œ, ì¸ì¦ë§Œ ë¶„ë¦¬
Â  Â  const authRes = await callWorker('authenticateManager', { pin, password });
Â  Â  stopLoadingAnimation();

Â  Â  if (authRes.success) {
Â  Â  Â  Â  currentChannelName = channelInfo.channelName;
Â  Â  Â  Â  currentChannelPin = pin;
Â  Â  Â  Â  managerPassword = password;
Â  Â  Â  Â  loginStatus.textContent = `ë¡œê·¸ì¸ ì„±ê³µ! [${currentChannelName}] ì±„ë„ ì—°ê²° ì™„ë£Œ`;
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  if (loginType === 'login_listen') {
Â  Â  Â  Â  Â  Â  Â  Â  loadContent('listen');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  loadContent('list_stories');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 500);
Â  Â  } else {
Â  Â  Â  Â  loginStatus.textContent = `ì¸ì¦ ì‹¤íŒ¨: ${authRes.message}`;
Â  Â  }
}

async function fetchStoriesForManagement() {
Â  Â  if (!currentChannelPin || !managerPassword) {
Â  Â  Â  Â  document.getElementById('storyListArea').innerHTML = '<p style="color: red;">ì¸ì¦ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.</p>';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const storyListArea = document.getElementById('storyListArea');
Â  Â  storyListArea.innerHTML = `<p>ì‚¬ì—° ëª©ë¡ì„ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;

Â  Â  startLoadingAnimation('ì‚¬ì—° ëª©ë¡ ë¡œë“œ ì¤‘');

Â  Â  const res = await callWorker('getAllStories', {
Â  Â  Â  Â  pin: currentChannelPin,
Â  Â  Â  Â  password: managerPassword
Â  Â  });

Â  Â  stopLoadingAnimation();

Â  Â  if (res.success) {
Â  Â  Â  Â  const stories = res.stories;
Â  Â  Â  Â  if (stories.length === 0) {
Â  Â  Â  Â  Â  Â  storyListArea.innerHTML = `<p>ì•„ì§ ë„ì°©í•œ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ“</p>`;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  let tableHtml = `
Â  Â  Â  Â  Â  Â  <form id="bulkUpdateForm">
Â  Â  Â  Â  Â  Â  <table class="story-table">
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ë‚ ì§œ</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ì´ë¦„</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th><span title="ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì „ì²´ ë‚´ìš©ì´ ë³´ì…ë‹ˆë‹¤.">ì‚¬ì—° (ì•ë¶€ë¶„ ì¼ë¶€)</span></th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>URL</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ìƒíƒœ</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ìŠ¹ì¸/ê±°ì ˆ</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody>`;

Â  Â  Â  Â  stories.forEach(story => {
Â  Â  Â  Â  Â  Â  let statusText = story.status;
Â  Â  Â  Â  Â  Â  let statusClass;
Â  Â  Â  Â  Â  Â  statusClass = `status-${story.status.toLowerCase()}`;
Â  Â  Â  Â  Â  Â  if (story.isPlayed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â statusText += ' (ì™„ë£Œ)';
Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  const contentSnippet = story.content.length > 15 ? story.content.substring(0, 15) + '...' : story.content;
Â  Â  Â  Â  Â  Â  const formattedDate = new Date(story.timestamp).toLocaleDateString('ko-KR');

Â  Â  Â  Â  Â  Â  tableHtml += `
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${formattedDate}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${story.name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td title="${story.content}" class="story-content-cell">${contentSnippet}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><a href="${story.youtubeUrl}" target="_blank">ë§í¬</a></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="${statusClass}">${statusText}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select name="status_${story.rowNum}" data-row="${story.rowNum}" class="status-select">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="${story.status}" selected disabled>${story.status}</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Approved" ${story.status === 'Approved' ? 'selected' : ''}>ìŠ¹ì¸ (Approved)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Rejected" ${story.status === 'Rejected' ? 'selected' : ''}>ê±°ì ˆ (Rejected)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Pending" ${story.status === 'Pending' ? 'selected' : ''}>ëŒ€ê¸° (Pending)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  });

Â  Â  Â  Â  tableHtml += `</tbody></table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="button-group" style="margin-top: 15px; background-color: var(--dark-wood); color: var(--dial-color);">ì¼ê´„ ì €ì¥ (ìƒíƒœ ë³€ê²½)</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>`;

Â  Â  Â  Â  storyListArea.innerHTML = tableHtml;
Â  Â  Â  Â  document.getElementById('bulkUpdateForm').addEventListener('submit', handleBulkSave);

Â  Â  } else {
Â  Â  Â  Â  storyListArea.innerHTML = `<p style="color: red;">ì‚¬ì—° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${res.message}</p>`;
Â  Â  }
}

async function handleBulkSave(e) {
Â  Â  e.preventDefault();
Â  Â  if (!currentChannelPin || !managerPassword) {
Â  Â  Â  Â  alert('ì±„ë„ ì¸ì¦ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  if (!confirm('ë³€ê²½ëœ ìƒíƒœë¥¼ ì„œë²„ì— ì¼ê´„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

Â  Â  const form = e.target;
Â  Â  const selectElements = form.querySelectorAll('.status-select');
Â  Â  const updates = [];
Â  Â  let isChanged = false;

Â  Â  selectElements.forEach(select => {
Â  Â  Â  Â  const initialStatus = select.options[0].value;
Â  Â  Â  Â  const newStatus = select.value;
Â  Â  Â  Â  if (initialStatus !== newStatus) {
Â  Â  Â  Â  Â  Â  updates.push({
Â  Â  Â  Â  Â  Â  Â  Â  rowNum: parseInt(select.dataset.row),
Â  Â  Â  Â  Â  Â  Â  Â  newStatus: newStatus
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  isChanged = true;
Â  Â  Â  Â  }
Â  Â  });

Â  Â  if (!isChanged) {
Â  Â  Â  Â  alert('ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const saveButton = form.querySelector('button[type="submit"]');
Â  Â  saveButton.textContent = 'ì €ì¥ ì¤‘...';
Â  Â  saveButton.disabled = true;

Â  Â  const res = await callWorker('bulkUpdateStories', {
Â  Â  Â  Â  pin: currentChannelPin,
Â  Â  Â  Â  password: managerPassword,
Â  Â  Â  Â  updates: updates
Â  Â  });

Â  Â  if (res.success) {
Â  Â  Â  Â  alert(res.message);
Â  Â  } else {
Â  Â  Â  Â  alert(`ì¼ê´„ ì €ì¥ ì‹¤íŒ¨: ${res.message}`);
Â  Â  }
Â  Â  fetchStoriesForManagement();
}

/** ğŸ’¡ playStories ê°œì„  (ì…”í”Œ ì˜¤ë¥˜ ë°©ì§€ ëª©ì ) */
async function playStories(mode) {
Â  Â  if (!currentChannelPin) {
Â  Â  Â  Â  alert('ì±„ë„ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  playMode = mode;

Â  Â  const playerArea = document.querySelector('#mainContent .scroll-text-box #playerArea');
Â  Â  if (playerArea) {
Â  Â  Â  Â  playerArea.innerHTML = `<p>ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
Â  Â  }

Â  Â  startLoadingAnimation('ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘');

Â  Â  // ğŸ’¡ ì„œë²„ì—ì„œ ëª¨ë“  ì‚¬ì—°ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
Â  Â  const allStoriesRes = await callWorker('getAllStories', { pin: currentChannelPin, password: managerPassword });
Â  Â  stopLoadingAnimation();

Â  Â  if (!allStoriesRes.success) {
Â  Â  Â  Â  mainContent.innerHTML = `<p style="color: red;">ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${allStoriesRes.message}</p>`;
Â  Â  Â  Â  frequencyDisplay.textContent = 'ì‚¬ì—° ë¡œë“œ ì‹¤íŒ¨';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const stories = allStoriesRes.stories || [];
Â  Â  const approvedStories = stories.filter(s => s.status === 'Approved');
Â  Â  const pendingStories = stories.filter(s => s.status === 'Pending');
Â  Â Â 
Â  Â  // ğŸ’¡ ì¬ìƒ ëª©ë¡ì„ ì¬êµ¬ì„±: ìŠ¹ì¸ë¨, ì•„ì§ ì¬ìƒë˜ì§€ ì•ŠìŒ, YouTube URL ìœ íš¨í•¨
Â  Â  const unplayedApprovedWithUrl = approvedStories.filter(s => 
Â  Â  Â  Â  !s.isPlayed && s.youtubeUrl && getYoutubeVideoId(s.youtubeUrl)
Â  Â  );

Â  Â  originalApprovedStories = approvedStories; // ğŸ’¡ ì „ì²´ ìŠ¹ì¸ëœ ì‚¬ì—° ì €ì¥
Â  Â  approvedUnplayedCount = unplayedApprovedWithUrl.length;Â 
Â  Â  currentPlayOrder = 0;Â 
Â  Â  currentStoryIndex = -1; // ì¬ìƒí•  ì¸ë±ìŠ¤ ì´ˆê¸°í™”

Â  Â  if (approvedStories.length === 0) {
Â  Â  Â  Â  mainContent.innerHTML = `
Â  Â  Â  Â  Â  Â  <h2 class="content-title">ğŸ¶ ì‚¬ì—° ì½ê¸°</h2>
Â  Â  Â  Â  Â  Â  <p>í˜„ì¬ ìŠ¹ì¸ëœ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì‚¬ì—°ì„ ìŠ¹ì¸í•´ ì£¼ì„¸ìš”.</p>
Â  Â  Â  Â  `;
Â  Â  Â  Â  frequencyDisplay.textContent = 'ìŠ¹ì¸ëœ ì‚¬ì—° ì—†ìŒ';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (approvedUnplayedCount === 0) {
Â  Â  Â  Â  if (pendingStories.length === 0) {
Â  Â  Â  Â  Â  Â  mainContent.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="content-title">ğŸ¶ ì‚¬ì—° ì½ê¸°</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p>ëª¨ë“  ì‚¬ì—°ì„ ì¬ìƒí–ˆìŠµë‹ˆë‹¤. ğŸ‰ ì±„ë„ì€ ìì •ì— ìë™ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤</p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  frequencyDisplay.textContent = 'ëª¨ë“  ì‚¬ì—° ì¬ìƒ ì™„ë£Œ';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  mainContent.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="content-title">ğŸ¶ ì‚¬ì—° ì½ê¸°</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p>ìŠ¹ì¸ëœ ì‚¬ì—°ì´ ëª¨ë‘ ì¬ìƒë˜ì—ˆìŠµë‹ˆë‹¤. <br>ëŒ€ê¸° ì¤‘ì¸ ì‚¬ì—° (${pendingStories.length}ê°œ)ì´ ìˆìŠµë‹ˆë‹¤. <br>ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì‚¬ì—°ì„ ìŠ¹ì¸í•´ ì£¼ì„¸ìš”.</p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  frequencyDisplay.textContent = `ëŒ€ê¸° ì‚¬ì—° (${pendingStories.length}) í™•ì¸ í•„ìš”`;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // ğŸ’¡ ìƒˆë¡œìš´ ì¬ìƒ ë¦¬ìŠ¤íŠ¸ ì„¤ì •
Â  Â  storyData = unplayedApprovedWithUrl;
Â  Â Â 
Â  Â  if (playMode === 'sequential') {
Â  Â  Â  Â  // ìˆœì°¨ ì¬ìƒ: íƒ€ì„ìŠ¤íƒ¬í”„ ìˆœìœ¼ë¡œ ì •ë ¬
Â  Â  Â  Â  storyData.sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());
Â  Â  } else {
Â  Â  Â  Â  // ëœë¤ ì¬ìƒ: ë¦¬ìŠ¤íŠ¸ ì…”í”Œ
Â  Â  Â  Â  shuffleArray(storyData);
Â  Â  }

Â  Â  currentStoryIndex = 0; // ì²« ë²ˆì§¸ ì‚¬ì—°ìœ¼ë¡œ ì‹œì‘

Â  Â  loadContent('listen', true); // ì¬ìƒ í™”ë©´ìœ¼ë¡œ ì´ë™

Â  Â  setTimeout(() => {
Â  Â  Â  Â  initFontToggleListeners();
Â  Â  Â  Â  applyTextSize(false);
Â  Â  Â  Â  const repeatBtn = document.getElementById('repeatScrollBtn');
Â  Â  Â  Â  if (repeatBtn) {
Â  Â  Â  Â  Â  Â  repeatBtn.classList.toggle('is-on', isRepeatScrolling);
Â  Â  Â  Â  }
Â  Â  Â  Â  loadYoutubeAPI();
Â  Â  }, 0);
}

function shuffleArray(arr) {
Â  Â  for (let i = arr.length - 1; i > 0; i--) {
Â  Â  Â  Â  const j = Math.floor(Math.random() * (i + 1));
Â  Â  Â  Â  [arr[i], arr[j]] = [arr[j], arr[i]];
Â  Â  }
}

function loadYoutubeAPI() {
Â  Â  if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
Â  Â  Â  Â  const tag = document.createElement('script');
Â  Â  Â  Â  tag.src = "https://www.youtube.com/iframe_api";
Â  Â  Â  Â  const firstScriptTag = document.getElementsByTagName('script')[0];
Â  Â  Â  Â  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
Â  Â  Â  Â  window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
Â  Â  } else {
Â  Â  Â  Â  onYouTubeIframeAPIReady();
Â  Â  }
}

function onYouTubeIframeAPIReady() {
Â  Â  const youtubeBox = document.getElementById('youtubePlayer');
Â  Â  if (!youtubeBox) {
Â  Â  Â  Â  console.error("YouTube Player DOM element not found.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // ğŸ’¡ ê¸°ì¡´ í”Œë ˆì´ì–´ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±° (ì¤‘ë³µ ìƒì„± ë°©ì§€)
Â  Â  if (player) {
Â  Â  Â  Â  player.destroy();
Â  Â  Â  Â  player = null;
Â  Â  }

Â  Â  player = new YT.Player('youtubePlayer', {
Â  Â  Â  Â  height: '100%',
Â  Â  Â  Â  width: '100%',
Â  Â  Â  Â  playerVars: {
Â  Â  Â  Â  Â  Â  'rel': 0,
Â  Â  Â  Â  Â  Â  'modestbranding': 1,
Â  Â  Â  Â  Â  Â  'autoplay': 1,
Â  Â  Â  Â  Â  Â  'disablekb': 1,
Â  Â  Â  Â  Â  Â  'iv_load_policy': 3,
Â  Â  Â  Â  Â  Â  'showinfo': 0,
Â  Â  Â  Â  Â  Â  'cc_load_policy': 0
Â  Â  Â  Â  },
Â  Â  Â  Â  events: {
Â  Â  Â  Â  Â  Â  'onReady': onPlayerReady,
Â  Â  Â  Â  Â  Â  'onStateChange': onPlayerStateChange,
Â  Â  Â  Â  Â  Â  'onError': onPlayerError // ğŸ’¡ ìœ íŠœë¸Œ í”Œë ˆì´ì–´ ì—ëŸ¬ í•¸ë“¤ë§ ì¶”ê°€
Â  Â  Â  Â  }
Â  Â  });
}

function onPlayerReady() {
Â  Â  // ğŸ’¡ playStoriesì—ì„œ currentStoryIndexë¥¼ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ, ë°”ë¡œ ì¬ìƒ ì‹œì‘
Â  Â  if (currentStoryIndex !== -1) {
Â  Â  Â  Â  playCurrentStory();
Â  Â  } else {
Â  Â  Â  Â  playNextStory();
Â  Â  }
}

function onPlayerError(event) {
Â  Â  console.error('YouTube Player Error:', event.data);
Â  Â  const errorMsg = `YouTube ì¬ìƒ ì˜¤ë¥˜ ë°œìƒ (ì½”ë“œ: ${event.data}). ë‹¤ìŒ ì‚¬ì—°ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.`;
Â  Â  frequencyDisplay.textContent = errorMsg;
Â  Â  const playerArea = document.getElementById('playerArea');
Â  Â  if (playerArea) playerArea.textContent = errorMsg;

Â  Â  // ğŸ’¡ ì˜¤ë¥˜ ë°œìƒ ì‹œ í•´ë‹¹ ì‚¬ì—°ì„ ì¬ìƒ ì™„ë£Œ ì²˜ë¦¬í•˜ê³  ë‹¤ìŒ ì‚¬ì—° ì¬ìƒ
Â  Â  if (currentStoryIndex !== -1 && storyData[currentStoryIndex]) {
Â  Â  Â  Â  const story = storyData[currentStoryIndex];
Â  Â  Â  Â  
Â  Â  Â  Â  callWorker('setStoryPlayed', {
Â  Â  Â  Â  Â  Â  pin: currentChannelPin,
Â  Â  Â  Â  Â  Â  rowNum: story.rowNum
Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  console.warn('[Playback Error] setStoryPlayed failed (ignored):', err);
Â  Â  Â  Â  });

Â  Â  Â  Â  storyData.splice(currentStoryIndex, 1);
Â  Â  Â  Â  currentStoryIndex = -1;
Â  Â  }
Â  Â  
Â  Â  setTimeout(playNextStory, 2000); // 2ì´ˆ í›„ ë‹¤ìŒ ê³¡ ì¬ìƒ ì‹œë„
}

function onPlayerStateChange(event) {
Â  Â  if (event.data === 1) {Â 
Â  Â  Â  Â  if (currentStoryIndex !== -1 && storyData[currentStoryIndex]) {
Â  Â  Â  Â  Â  Â  const story = storyData[currentStoryIndex];

Â  Â  Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  Â  Â  if (lastStartedRowNum !== story.rowNum || (now - lastStartedStamp) > 2000) {
Â  Â  Â  Â  Â  Â  Â  Â  lastStartedRowNum = story.rowNum;
Â  Â  Â  Â  Â  Â  Â  Â  lastStartedStamp = now;

Â  Â  Â  Â  Â  Â  Â  Â  (async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await callWorker('setStoryStarted', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pin: currentChannelPin,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rowNum: story.rowNum,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startedAt: now
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('ì¬ìƒ ì‹œì‘ ì²´í¬ ì‹¤íŒ¨(ë¬´ì‹œ):', e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  })();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const storyInfoElement = document.getElementById('currentStoryInfo');
Â  Â  Â  Â  Â  Â  if (storyInfoElement) {
Â  Â  Â  Â  Â  Â  Â  Â  storyInfoElement.textContent = `${approvedUnplayedCount}ê°œ ì‚¬ì—° ì¤‘ ${currentPlayOrder}ë²ˆì§¸`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  if (event.data === 0) {Â // ğŸ’¡ ì¬ìƒ ì¢…ë£Œ
Â  Â  Â  Â  // í˜„ì¬ ì¬ìƒ ì¤‘ì´ë˜ ì‚¬ì—°ì„ ì¬ìƒ ì™„ë£Œ ì²˜ë¦¬
Â  Â  Â  Â  if (currentStoryIndex !== -1 && storyData[currentStoryIndex]) {
Â  Â  Â  Â  Â  Â  const story = storyData[currentStoryIndex];

Â  Â  Â  Â  Â  Â  // ì„œë²„ì— ì¬ìƒ ì™„ë£Œ ë³´ê³  (ë¹„ë™ê¸°)
Â  Â  Â  Â  Â  Â  callWorker('setStoryPlayed', {
Â  Â  Â  Â  Â  Â  Â  Â  pin: currentChannelPin,
Â  Â  Â  Â  Â  Â  Â  Â  rowNum: story.rowNum
Â  Â  Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('[Playback] setStoryPlayed failed (ignored):', err);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // ì¬ìƒ ëª©ë¡ì—ì„œ ì‚¬ì—° ì œê±°
Â  Â  Â  Â  Â  Â  storyData.splice(currentStoryIndex, 1);
Â  Â  Â  Â  Â  Â  currentStoryIndex = -1; // ë‹¤ìŒ ì¬ìƒì„ ìœ„í•´ ë¦¬ì…‹
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  playNextStory();
Â  Â  }
}

function playCurrentStory() {
Â  Â  if (currentStoryIndex === -1 || !storyData[currentStoryIndex] || !player) {
Â  Â  Â  Â  console.warn("í˜„ì¬ ì¬ìƒí•  ì‚¬ì—° ì •ë³´ê°€ ì—†ê±°ë‚˜ í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
Â  Â  Â  Â  playNextStory();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  currentPlayOrder++;

Â  Â  const story = storyData[currentStoryIndex];
Â  Â  const videoId = getYoutubeVideoId(story.youtubeUrl);

Â  Â  if (videoId) {
Â  Â  Â  Â  // ğŸ’¡ ë¡œë“œ ì „ì— ìŠ¤í¬ë¡¤ ë©ˆì¶¤ ë° í…ìŠ¤íŠ¸ ì„¤ì •
Â  Â  Â  Â  const scrollingText = document.getElementById('scrollingText');
Â  Â  Â  Â  scrollingText.textContent = `[${story.name} ë‹˜ì˜ ì‚¬ì—°]\n${story.content}`;
Â  Â  Â  Â  restartCurrentScrolling(); // ìŠ¤í¬ë¡¤ ì¬ì‹œì‘ (duration ì¬ê³„ì‚° í¬í•¨)

Â  Â  Â  Â  player.loadVideoById(videoId);
Â  Â  Â  Â  frequencyDisplay.textContent = `ON AIR: ${story.name} ë‹˜ì˜ ì‚¬ì—° (ì±„ë„: ${currentChannelName})`;

Â  Â  Â  Â  const storyInfoElement = document.getElementById('currentStoryInfo');
Â  Â  Â  Â  if (storyInfoElement) {
Â  Â  Â  Â  Â  Â  storyInfoElement.textContent = `${approvedUnplayedCount}ê°œ ì‚¬ì—° ì¤‘ ${currentPlayOrder}ë²ˆì§¸`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const playerArea = document.getElementById('playerArea');
Â  Â  Â  Â  if (playerArea) {
Â  Â  Â  Â  Â  Â  Â playerArea.innerHTML = ``;
Â  Â  Â  Â  }

Â  Â  } else {
Â  Â  Â  Â  console.error('ìœ íš¨í•˜ì§€ ì•Šì€ YouTube URL ë˜ëŠ” ID: ', story.youtubeUrl);
Â  Â  Â  Â  // ğŸ’¡ ìœ íš¨í•˜ì§€ ì•Šì€ URLì€ ì¬ìƒ ì™„ë£Œ ì²˜ë¦¬í•˜ê³  ëª©ë¡ì—ì„œ ì œê±° í›„ ë‹¤ìŒ ì‚¬ì—° ì¬ìƒ
Â  Â  Â  Â  currentPlayOrder--; 
Â  Â  Â  Â  
Â  Â  Â  Â  storyData.splice(currentStoryIndex, 1); // ëª©ë¡ì—ì„œ ì œê±°
Â  Â  Â  Â  currentStoryIndex = -1; // ì¸ë±ìŠ¤ ë¦¬ì…‹
Â  Â  Â  Â  
Â  Â  Â  Â  // ğŸ’¡ ì„œë²„ì— isPlayed = trueë¡œ ì—…ë°ì´íŠ¸ëŠ” ìƒëµ. (ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë„ë¡)
Â  Â  Â  Â  playNextStory(); 
Â  Â  }
}


function playNextStory() {
Â  Â  const storyInfoElement = document.getElementById('currentStoryInfo');
Â  Â  const playerArea = document.getElementById('playerArea');

Â  Â  if (storyData.length === 0) {
Â  Â  Â  Â  if (playerArea) {
Â  Â  Â  Â  Â  Â  Â playerArea.innerHTML = `<p>ë‹¤ìŒ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒíƒœë¥¼ ê°±ì‹ í•´ ì£¼ì„¸ìš”.</p>`;
Â  Â  Â  Â  }
Â  Â  Â  Â  frequencyDisplay.textContent = 'ì¬ìƒ ëª©ë¡ ì¢…ë£Œ';
Â  Â  Â  Â  if (storyInfoElement) {
Â  Â  Â  Â  Â  Â  // originalApprovedStories.length: ìŠ¹ì¸ëœ ì „ì²´ ì‚¬ì—° ìˆ˜
Â  Â  Â  Â  Â  Â  // approvedUnplayedCount: ìµœì´ˆ ì¬ìƒ ì‹œì‘ ì‹œì ì˜ ë¯¸ì¬ìƒ ì‚¬ì—° ìˆ˜
Â  Â  Â  Â  Â  Â  const totalStories = originalApprovedStories.length;
Â  Â  Â  Â  Â  Â  storyInfoElement.textContent = `${totalStories}ê°œ ì‚¬ì—° ì¤‘ ${approvedUnplayedCount}ê°œ ì™„ë£Œ (ìƒˆë¡œê³ ì¹¨ í•„ìš”)`;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  if (player) player.stopVideo();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // ğŸ’¡ ì´ë¯¸ playStoriesì—ì„œ 0ìœ¼ë¡œ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ ë‹¤ì‹œ 0ìœ¼ë¡œ ì„¤ì •
Â  Â  currentStoryIndex = 0;Â 
Â  Â  playCurrentStory();
}


function toggleRepeatScrolling(btn) {
Â  Â  isRepeatScrolling = !isRepeatScrolling;
Â  Â  if (btn) {
Â  Â  Â  Â  btn.classList.toggle('is-on', isRepeatScrolling);
Â  Â  }
Â  Â  if (isRepeatScrolling) {
Â  Â  Â  Â  restartCurrentScrolling();
Â  Â  } else {
Â  Â  Â  Â  if (scrollWatchTimer) {
Â  Â  Â  Â  Â  Â  clearInterval(scrollWatchTimer);
Â  Â  Â  Â  Â  Â  scrollWatchTimer = null;
Â  Â  Â  Â  }
Â  Â  }
}

function restartCurrentScrolling() {
Â  Â  const el = document.getElementById('scrollingText');
Â  Â  if (!el) return;

Â  Â  // ğŸ’¡ ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™” (ìŠ¤í¬ë¡¤ ëì— ë„ë‹¬í–ˆì„ ë•Œë§Œ)
Â  Â  if (el.style.animationName === 'scrollUp') {
Â  Â  Â  Â  el.style.animation = 'none';
Â  Â  Â  Â  el.style.top = '100%';
Â  Â  Â  Â  el.style.animationDelay = '0s';
Â  Â  Â  Â  
Â  Â  Â  Â  // ğŸ’¡ CSS ë³€ê²½ì„ ìœ„í•œ ê°•ì œ ë¦¬í”Œë¡œìš°
Â  Â  Â  Â  el.offsetHeight; 
Â  Â  }

Â  Â  setTimeout(() => {
Â  Â  Â  Â  el.classList.remove('size-small', 'size-large');
Â  Â  Â  Â  el.classList.add(textSizeMode === 'large' ? 'size-large' : 'size-small');

Â  Â  Â  Â  setScrollAnimationDuration(el);
Â  Â  Â  Â  applyTextSize(false);

Â  Â  Â  Â  startScrollWatcher();
Â  Â  }, 50);
}

function setScrollAnimationDuration(el) {
Â  Â  const container = el.parentElement;
Â  Â  if (!container) return;

Â  Â  const boxHeight = container.getBoundingClientRect().height;
Â  Â  const textHeight = el.getBoundingClientRect().height;

Â  Â  let scrollDistance = textHeight + boxHeight + 40;Â 

Â  Â  let durationSec = scrollDistance / SCROLL_SPEED;
Â  Â  if (durationSec < MIN_SCROLL_SEC) durationSec = MIN_SCROLL_SEC;
Â  Â  if (durationSec > MAX_SCROLL_SEC) durationSec = MAX_SCROLL_SEC;

Â  Â  el.style.animation = `scrollUp ${durationSec}s linear forwards`;
}

function startScrollWatcher() {
Â  Â  if (scrollWatchTimer) {
Â  Â  Â  Â  clearInterval(scrollWatchTimer);
Â  Â  Â  Â  scrollWatchTimer = null;
Â  Â  }

Â  Â  const el = document.getElementById('scrollingText');
Â  Â  if (!el) return;

Â  Â  scrollWatchTimer = setInterval(() => {
Â  Â  Â  Â  if (!isRepeatScrolling) {
Â  Â  Â  Â  Â  Â  clearInterval(scrollWatchTimer);
Â  Â  Â  Â  Â  Â  scrollWatchTimer = null;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const container = el.parentElement;
Â  Â  Â  Â  if (!container) return;

Â  Â  Â  Â  const elRect = el.getBoundingClientRect();
Â  Â  Â  Â  const boxRect = container.getBoundingClientRect();

Â  Â  Â  Â  const isOut = elRect.bottom < boxRect.top;

Â  Â  Â  Â  if (isOut) {
Â  Â  Â  Â  Â  Â  clearInterval(scrollWatchTimer);
Â  Â  Â  Â  Â  Â  scrollWatchTimer = null;
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (isRepeatScrolling) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  restartCurrentScrolling();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 1200);Â 
Â  Â  Â  Â  }
Â  Â  }, 400);
}

document.addEventListener('animationend', function (e) {
Â  Â  if (e.target && e.target.id === 'scrollingText') {
Â  Â  Â  Â  if (isRepeatScrolling) {
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (isRepeatScrolling) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  restartCurrentScrolling();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 1200);
Â  Â  Â  Â  }
Â  Â  }
});

function getYoutubeVideoId(url) {
Â  Â  if (!url) return null;
Â  Â  const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|\w+\/|watch\?v=)|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
Â  Â  if (match && match[1]) return match[1];
Â  Â  try {
Â  Â  Â  Â  const u = new URL(url, window.location.origin);
Â  Â  Â  Â  const v = u.searchParams.get('v');
Â  Â  Â  Â  if (v && v.length === 11) return v;
Â  Â  } catch (e) {}
Â  Â  return null;
}

let searchResultsData = [];

async function handleSearch() {
Â  Â  const queryInput = document.getElementById('searchQuery');
Â  Â  const query = queryInput.value.trim();
Â  Â  const resultsContainer = document.getElementById('searchResults');
Â  Â  const storyUrlInput = document.getElementById('storyUrl');

Â  Â  if (query.length < 2) {
Â  Â  Â  Â  resultsContainer.innerHTML = '<li>ê²€ìƒ‰ì–´ë¥¼ ë‘ ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.</li>';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  resultsContainer.innerHTML = '<li>ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</li>';

Â  Â  startLoadingAnimation('YouTube ê²€ìƒ‰ ì¤‘');

Â  Â  const res = await callWorker('searchYoutube', { query: query });

Â  Â  stopLoadingAnimation();

Â  Â  if (res.success && res.results.length > 0) {
Â  Â  Â  Â  searchResultsData = res.results;
Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  res.results.forEach((item, index) => {
Â  Â  Â  Â  Â  Â  html += `<li onclick="selectSong(${index})">ğŸµ ${item.title}</li>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  resultsContainer.innerHTML = html;
Â  Â  } else {
Â  Â  Â  Â  resultsContainer.innerHTML = `<li>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. URLì„ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</li>`;
Â  Â  Â  Â  storyUrlInput.value = '';
Â  Â  }
}

function selectSong(index) {
Â  Â  const selected = searchResultsData[index];
Â  Â  const storyUrlInput = document.getElementById('storyUrl');
Â  Â  const resultsContainer = document.getElementById('searchResults');
Â  Â  storyUrlInput.value = selected.url;
Â  Â  resultsContainer.innerHTML = `<li>âœ… ${selected.title} ì„ íƒ ì™„ë£Œ!</li>`;
}

window.onload = () => {
Â  Â  loadContent('welcome');
};
</script>
</body>
</html>
